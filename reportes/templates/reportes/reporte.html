{% extends 'home.html' %}
{% load static %}
{% load humanize %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/reportes.css' %}">
{% endblock %}

{% block content %}
<main class="main-content reportes-page">
    <h1 class="page-title">Reportes de Inventario</h1>

    <!-- Estadísticas principales -->
    <div class="stats-grid">
        <div class="stat-card red">
            <img src="{% static 'img/warning.svg' %}" alt="Productos críticos" class="stat-icon">
            <div>
                <p class="stat-label">Productos Críticos</p>
                <p class="stat-value">{{ count_criticos|default:0 }}</p>
            </div>
        </div>

        <div class="stat-card yellow">
            <img src="{% static 'img/bajo.svg' %}" alt="Bajo stock" class="stat-icon">
            <div>
                <p class="stat-label">Bajo Stock</p>
                <p class="stat-value">{{ count_bajo_stock|default:0 }}</p>
            </div>
        </div>

        <div class="stat-card green">
            <img src="{% static 'img/dolar.svg' %}" alt="Valor en riesgo" class="stat-icon">
            <div>
                <p class="stat-label">Valor en Riesgo</p>
                <p class="stat-value">$ {{ valor_en_riesgo|default:0 }}</p>
            </div>
        </div>

        <div class="stat-card blue">
            <img src="{% static 'img/cuadro.svg' %}" alt="Categorías" class="stat-icon">
            <div>
                <p class="stat-label">Total de Categorías</p>
                <p class="stat-value">{{ total_categorias|default:0 }}</p>
            </div>
        </div>
    </div>

    <!-- Reportes principales -->
    <div class="reports-grid">

        <!-- Reporte: Stock bajo -->
        <div class="report-card report-left">
            <div class="card-header">
                <img src="{% static 'img/warning.svg' %}" alt="Alerta" class="card-icon">
                <h2>Reporte de Stock Bajo</h2>
            </div>
            <p class="subtitle">Productos que requieren reabastecimiento</p>

            <div class="stock-list">
                {% for producto in lista_reporte_stock %}
                    <div class="stock-item">
                        <div class="stock-info">
                            <strong>{{ producto.name }}</strong>
                            <p class="muted">{{ producto.category }}</p>
                        </div>
                        <div class="stock-meta">
                            <span class="qty">{{ producto.stock }} unidades</span>

                            {% if producto.stock == 0 %}
                                <span class="badge out">Agotado</span>
                            {% elif producto.stock <= NIVEL_CRITICO %}
                                <span class="badge out">Crítico</span>
                            {% else %}
                                <span class="badge low">Bajo stock</span>
                            {% endif %}
                        </div>
                    </div>
                {% empty %}
                    <div class="stock-item">
                        <div class="stock-info">
                            <strong>¡Todo en orden!</strong>
                            <p class="muted">No hay productos con bajo stock.</p>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <div class="impacto">
                <h3>Impacto financiero</h3>
                <p><strong>Productos en riesgo (Críticos):</strong> {{ count_criticos|default:0 }} productos</p>
                <p><strong>Valor total en riesgo:</strong>
                  <span class="text-danger">$ {{ valor_en_riesgo }}</span>
                </p>
                <p><strong>Reorden sugerido:</strong>
                  <span class="text-primary">$ {{ impacto_reorden_sugerido }}</span>
                </p>
            </div>
        </div>

        <!-- Reporte: Análisis por categoría -->
        <div class="report-card report-right">
            <div class="card-header">
                <img src="{% static 'img/est.svg' %}" alt="Análisis" class="card-icon">
                <h2>Análisis por Categoría</h2>
            </div>
            <p class="subtitle">Distribución de inventario por categorías</p>

            <div class="category-list">
                {% for cat in analisis_categorias %}
                    <div class="category-item">
                        <div class="label">
                            <span class="cat-name">{{ cat.category }}</span>
                            <span class="cat-count">{{ cat.num_productos }} Productos</span>
                        </div>
                        <div class="progress-bar">
                             <div style="width:{{ cat.porcentaje|default:0|floatformat:0 }}%"></div>
                        </div>
                        <div class="cat-meta">
                            <span>Valor total: $ {{ cat.valor_total_categoria }}</span>
                            <span class="pct">{{ cat.porcentaje|default:0|floatformat:0 }}%</span>
                        </div>
                    </div>
                {% empty %}
                    <div class="category-item">
                        <div class="label">
                            <span class="cat-name">Sin datos</span>
                            <span class="cat-count">0 Productos</span>
                        </div>
                        <div class="progress-bar"><div style="width:0%"></div></div>
                        <div class="cat-meta">
                            <span>Valor total: $ 0</span>
                            <span class="pct">0%</span>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Exportación -->
    <div class="export-section">
        <div class="export-card">
            <div class="card-header">
                <img src="{% static 'img/verde.svg' %}" alt="Exportar" class="card-icon">
                <h3>Exportar Inventario</h3>
            </div>
            <p>Genere reportes completos en Excel o PDF.</p>
            <div class="btn-group">
                <a href="{% url 'exportar_excel' %}" class="btn-excel">
                    <img src="{% static 'img/descarga.svg' %}" alt="Excel" class="btn-icon">
                    Excel
                </a>
                <a href="{% url 'exportar_pdf' %}" class="btn-pdf">
                    <img src="{% static 'img/descarga.svg' %}" alt="PDF" class="btn-icon">
                    PDF
                </a>
            </div>
        </div>

        <div class="export-card">
            <h3>Inventario Completo</h3>
            <p>Reporte detallado con todos los productos, categorías y valoraciones.</p>
            <div class="btn-group">
                <a href="{% url 'exportar_excel_completo' %}" class="btn-excel">
                    <img src="{% static 'img/descarga.svg' %}" alt="Excel" class="btn-icon">
                    Excel Completo
                </a>
                <a href="{% url 'exportar_pdf_completo' %}" class="btn-pdf">
                    <img src="{% static 'img/descarga.svg' %}" alt="PDF" class="btn-icon">
                    PDF Completo
                </a>
            </div>
        </div>
    </div>
</main>
{% endblock %}